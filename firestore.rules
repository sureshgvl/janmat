rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Plans collection - public read, admin write
    match /plans/{planId} {
      allow read: if true; // Public read for all users
      allow write: if request.auth != null &&
        (request.auth.uid == '8BYU2by0IOOBVAodl5sFwuqOm4Z2' ||
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // User subscriptions - users can read/write their own, admin can read/write all
    match /user_subscriptions/{subscriptionId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      allow write: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }

    // ‚≠ê HIGHLIGHTS COLLECTION - NEW!
    match /highlights/{highlightId} {
      allow read: if true; // Public read for voters to see highlights
      allow write: if request.auth != null; // Authenticated users can create
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.candidateId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }

    // üì¢ PUSH FEED COLLECTION - NEW!
    match /pushFeed/{feedId} {
      allow read: if true; // Public read for voters
      allow write: if request.auth != null; // Authenticated users can create
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.candidateId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }

    // üí∞ PAYMENTS COLLECTION - NEW!
    match /payments/{paymentId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.candidateId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      allow write: if request.auth != null &&
        request.auth.uid == resource.data.candidateId;
    }

    // Users collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
      // Allow authenticated users to read candidate profiles for display purposes
      allow read: if request.auth != null;
      // Allow account linking: authenticated users can update their own profile
      // This is needed for linking multiple auth methods (OTP ‚Üî Google)
      allow update: if request.auth != null;
    }

    // Chat functionality
    match /chats/{roomId} {
      allow read, write: if request.auth != null;
    }

    match /chats/{roomId}/messages/{messageId} {
      allow read, write: if request.auth != null;
    }

    // User quotas
    match /user_quotas/{userId} {
      allow read, write: if request.auth != null;
    }

    // Admin collections (districts, etc.) - allow authenticated users to read for profile completion
    match /districts/{districtId} {
      allow read: if request.auth != null; // Allow authenticated users to read districts for profile completion
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /districts/{districtId}/bodies/{bodyId} {
      allow read: if request.auth != null; // Allow authenticated users to read bodies for profile completion
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /districts/{districtId}/bodies/{bodyId}/wards/{wardId} {
      allow read: if request.auth != null; // Allow authenticated users to read wards for profile completion
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // Candidates subcollection under wards
    match /districts/{districtId}/bodies/{bodyId}/wards/{wardId}/candidates/{candidateId} {
      allow read: if request.auth != null; // Allow authenticated users to read candidates
      allow create: if request.auth != null &&
        (request.auth.uid == request.resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow delete: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // Device management for multi-device login prevention
    match /users/{userId}/devices/{deviceId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // A/B Testing collections
    match /ab_tests/{testId} {
      allow read: if request.auth != null; // Authenticated users can read active tests
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /ab_conversions/{conversionId} {
      allow read: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow write: if request.auth != null; // Authenticated users can write conversion events
    }

    // Analytics and session tracking
    match /user_sessions/{sessionId} {
      allow read, write: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // Video processing
    match /processed_videos/{videoId} {
      allow read, write: if request.auth != null; // Authenticated users can access processed videos
    }

    // Party symbols and information
    match /parties/{partyId} {
      allow read: if true; // Public read for party information
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // Monetization collections
    match /subscriptions/{subscriptionId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow create: if request.auth != null &&
        (request.auth.uid == request.resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /xp_transactions/{transactionId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow create: if request.auth != null &&
        (request.auth.uid == request.resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // Legacy collections (for backward compatibility)
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null;
    }

    match /rewards/{rewardId} {
      allow read, write: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /reported_messages/{reportId} {
      allow read: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow write: if request.auth != null; // Users can report messages
    }

    // Candidate data structure (legacy - districts/bodies/wards/candidates is preferred)
    match /cities/{cityId} {
      allow read: if request.auth != null; // Allow authenticated users to read cities
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /cities/{cityId}/wards/{wardId} {
      allow read: if request.auth != null; // Allow authenticated users to read wards
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /wards/{wardId} {
      allow read: if request.auth != null; // Allow authenticated users to read wards
      allow write: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    match /candidates/{candidateId} {
      allow read: if true; // Public read for candidate information
      allow create: if request.auth != null &&
        (request.auth.uid == request.resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
      allow delete: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         request.auth.token.admin == true || request.auth.token.role == 'admin');
    }

    // Candidate index for search optimization
    match /candidate_index/{candidateId} {
      allow read: if request.auth != null; // Authenticated users can search candidates
      allow write: if request.auth != null; // Allow authenticated users to create/update index
    }

    // User subcollections
    match /users/{userId}/following/{followingId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /users/{userId}/activities/{activityId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Sponsored updates collection - for push feed content
    match /sponsored_updates/{updateId} {
      allow read: if request.auth != null; // Authenticated users can read sponsored content
      allow write: if request.auth != null &&
        (request.auth.uid == resource.data.authorId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.authorId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }

    // Community posts collection - for community feed content
    match /community_posts/{postId} {
      allow read: if request.auth != null; // Authenticated users can read community posts
      allow write: if request.auth != null &&
        (request.auth.uid == resource.data.authorId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.authorId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }

    // Section views collection - for analytics tracking
    match /section_views/{viewId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.userId ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      allow write: if request.auth != null; // Authenticated users can write view events
    }

    // Typing status collection - for real-time typing indicators
    match /typing_status/{statusId} {
      allow read: if request.auth != null; // Authenticated users can read typing status
      allow write: if request.auth != null; // Authenticated users can write typing status
      allow delete: if request.auth != null; // Authenticated users can delete typing status
    }

    // Poll index collection - for poll lookup optimization
    match /poll_index/{pollId} {
      allow read: if request.auth != null; // Authenticated users can read poll index
      allow write: if request.auth != null; // Authenticated users can write poll index
    }

    // User mappings collection - for account linking between auth methods
    match /user_mappings/{mappingId} {
      allow read, write: if request.auth != null && request.auth.uid == mappingId;
      allow read: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }
  }
}
