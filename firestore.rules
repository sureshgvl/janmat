rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read and write their own user documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can read all candidates but only authenticated users can write
    match /candidates/{candidateId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Manifesto polls - authenticated users can read/write
    match /manifesto_polls/{manifestoId}/polls/{pollId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Comments - authenticated users can read/write
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Comment likes - authenticated users can read/write
    match /comment_likes/{likeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Manifesto likes - authenticated users can read/write
    match /likes/{likeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Conversations - users can only access their own conversations
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null &&
        (conversationId == request.auth.uid + '_' + resource.data.candidateId ||
         conversationId == resource.data.userId + '_' + request.auth.uid);
    }

    // Messages within conversations
    match /conversations/{conversationId}/messages/{messageId} {
      allow read, write: if request.auth != null &&
        (conversationId == request.auth.uid + '_' + get(/databases/$(database)/documents/conversations/$(conversationId)).data.candidateId ||
         conversationId == get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId + '_' + request.auth.uid);
    }

    // Wards - public read access
    match /wards/{wardId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Rewards - users can only access their own rewards
    match /rewards/{rewardId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // XP transactions - users can only access their own transactions
    match /xp_transactions/{transactionId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Following relationships
    match /users/{userId}/following/{followingId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Followers relationships
    match /candidates/{candidateId}/followers/{followerId} {
      allow read, write: if request.auth != null && request.auth.uid == followerId;
    }

    // Notifications - users can only access their own notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Default deny for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
