rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Chat media files (images, audio, video)
    match /chat_media/{roomId}/{allPaths=**} {
      // Allow read for authenticated users who can access the chat room
      allow read: if request.auth != null &&
        (_canAccessRoom(request.auth.uid, roomId));

      // Allow write for authenticated users who can access the room
      allow write: if request.auth != null &&
        _canAccessRoom(request.auth.uid, roomId) &&
        _isValidFileType(request.resource.contentType);

      // Allow delete for file owner or admins
      allow delete: if request.auth != null &&
        (request.auth.uid == _getFileOwner(resource.name) ||
         _isAdmin(request.auth.uid));
    }

    // User profile images (old path - maintaining backward compatibility)
    match /profile_images/{userId}/{allPaths=**} {
      allow read: if true; // Public read for profile images
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Profile photos (current implementation path)
    match /profile_photos/{userId}/{allPaths=**} {
      allow read: if true; // Public read for profile photos
      allow write: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Candidate media files
    match /candidate_media/{candidateId}/{allPaths=**} {
      allow read: if true; // Public read for candidate media
      allow write: if request.auth != null &&
        (request.auth.uid == candidateId || _isAdmin(request.auth.uid));
      allow delete: if request.auth != null &&
        (request.auth.uid == candidateId || _isAdmin(request.auth.uid));
    }

    // Manifesto files (PDF, images, videos)
    match /manifesto_files/{candidateId}/{allPaths=**} {
      allow read: if true; // Public read for manifesto files
      allow write: if request.auth != null; // Allow all authenticated users to write
      allow delete: if request.auth != null; // Allow all authenticated users to delete
    }

    // Achievement photos
    match /achievements/{allPaths=**} {
      allow read: if true; // Public read for achievement photos
      allow write: if request.auth != null; // Allow all authenticated users to write
      allow delete: if request.auth != null; // Allow all authenticated users to delete
    }

    // Media files (images, videos for candidate media gallery)
    match /media/{allPaths=**} {
      allow read: if true; // Public read for media files
      allow write: if request.auth != null; // Allow all authenticated users to write
      allow delete: if request.auth != null; // Allow all authenticated users to delete
    }

    // Candidate media files (background sync uploads)
    match /candidates/{candidateId}/media/{allPaths=**} {
      allow read: if true; // Public read for candidate media
      allow write: if request.auth != null &&
        (request.auth.uid == candidateId || _isAdmin(request.auth.uid));
      allow delete: if request.auth != null &&
        (request.auth.uid == candidateId || _isAdmin(request.auth.uid));
    }

    // Manifesto media files (PDF, images, videos)
    match /manifesto_media/{candidateId}/{allPaths=**} {
      allow read: if true; // Public read for manifesto media files
      allow write: if request.auth != null; // Allow all authenticated users to write
      allow delete: if request.auth != null; // Allow all authenticated users to delete
    }

    // Candidate symbol images (for independent candidates)
    match /candidate_symbols/{allPaths=**} {
      allow read: if true; // Public read for symbol images
      allow write: if request.auth != null; // Allow all authenticated users to upload symbols
      allow delete: if request.auth != null; // Allow all authenticated users to delete symbols
    }

    // Highlight banner images
    match /highlight_banners/{candidateId}/{allPaths=**} {
      allow read: if true; // Public read for highlight banner images
      allow write: if request.auth != null &&
        (request.auth.uid == candidateId || _isAdmin(request.auth.uid));
      allow delete: if request.auth != null &&
        (request.auth.uid == candidateId || _isAdmin(request.auth.uid));
    }
  }

  // Helper functions
  function _canAccessRoom(userId, roomId) {
    // For hierarchical chat structures, allow authenticated users
    // This covers all room types (legacy flat, ward_*, area_*, etc.)
    return request.auth != null;
  }

  function _isValidFileType(contentType) {
    return contentType.matches('image/.*') ||
           contentType.matches('audio/.*') ||
           contentType.matches('video/.*') ||
           contentType == 'application/pdf';
  }

  function _getFileOwner(fileName) {
    // Extract user ID from file path
    let pathParts = fileName.split('/');
    return pathParts[1]; // Assuming format: chat_media/roomId/userId/filename
  }

  function _isAdmin(userId) {
    return firestore.get(/databases/(default)/documents/users/$(userId)).data.role == 'admin';
  }
}
